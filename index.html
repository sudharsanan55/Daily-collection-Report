<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Daily Collection Report</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ------------- THEME ------------- */
:root{
  --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;
  --accent:#22c55e;--ring:#22c55e33;
}
.light{
  --bg:#f8fafc;--card:#ffffffee;--muted:#64748b;--text:#0f172a;
  --accent:#0d9488;--ring:#0d948833;
}
@media (prefers-color-scheme:light){:root:not(.darkPref){--bg:#f8fafc;--card:#ffffffee;--text:#0f172a}}
/* ------------- RESET ------------- */
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);color:var(--text);transition:.25s background}
button,input,select{font:inherit}
a{color:inherit;text-decoration:none}
/* ------------- LAYOUT ------------ */
.container{max-width:1100px;margin:32px auto;padding:0 16px}
.grid{display:grid;gap:16px}
.grid-2{grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
.card{background:var(--card);backdrop-filter:blur(8px);border:1px solid rgba(0,0,0,.08);
      border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.16);transition:.25s background}
.card h2{margin:0 0 12px;font-size:20px;font-weight:700}
.card .content{padding:18px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;padding:11px 13px;border-radius:12px;border:1px solid rgba(0,0,0,.12);
             background:transparent;color:var(--text);outline:none}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 4px var(--ring)}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
.btns{display:flex;flex-wrap:wrap;gap:10px}
button{appearance:none;border:1px solid rgba(0,0,0,.12);background:transparent;
       color:var(--text);padding:9px 14px;border-radius:12px;cursor:pointer;font-weight:600;
       display:inline-flex;align-items:center;gap:4px}
button.primary{background:var(--accent);border-color:var(--accent);color:#08160f}
button.ghost{background:transparent}
button:focus{outline:none;box-shadow:0 0 0 4px var(--ring)}
/* ------------- TABLE ------------- */
.tablewrap{overflow:auto;border-radius:14px;border:1px solid rgba(0,0,0,.12)}
table{width:100%;border-collapse:collapse;background:transparent;font-size:14px}
th,td{padding:10px 10px;text-align:left;border-bottom:1px solid rgba(0,0,0,.08);white-space:nowrap}
th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;cursor:pointer;user-select:none}
th.sort-asc::after{content:" ▲";font-size:10px}
th.sort-desc::after{content:" ▼";font-size:10px}
tfoot td{font-weight:700}
.pill{display:inline-flex;align-items:center;padding:3px 9px;border-radius:99px;font-size:12px}
.yes{background:#052e1a;color:#8ff0b1;border:1px solid #1d7a4a}
.no{background:#330909;color:#ffb5ab;border:1px solid #7a1d1d}
.empty{color:var(--muted);text-align:center;padding:22px}
.small{font-size:12px;color:var(--muted)}
.danger{color:#ff6b6b}
.success{color:#7cf29a}
.right{display:flex;justify-content:flex-end;gap:10px}
.nowrap{white-space:nowrap}
input[type="number"]::-webkit-inner-spin-button{margin-left:4px}
.themeTgl{font-size:18px;line-height:1}
tr.editing td{background:rgba(0,0,0,.06)}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="container">
<header class="grid" style="gap:10px;margin-bottom:18px">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <h1 style="margin:0;font-size:28px">💼 Daily Collection Report</h1>
    <button id="themeBtn" class="ghost themeTgl" title="Toggle theme">🌙</button>
  </div>
  <p class="small" style="margin:0">Fields marked with * are required. Data stays in your browser.</p>
</header>

<!-- ── FORM + FILTERS ─────────────────────────────── -->
<section class="grid grid-2" style="align-items:start">
  <!-- new entry -->
  <div class="card">
    <div class="content">
      <h2>New Entry</h2>
      <form id="entryForm" autocomplete="off">
        <div class="row">
          <div><label>* Date</label><input type="date" id="date" required></div>
          <div><label>* Number / Name</label><input type="text" id="number" required></div>
        </div>
        <div class="row" style="margin-top:12px">
          <div><label>* Amount (₹)</label><input type="number" id="amount" min="0" step="0.01" required></div>
          <div><label>* G-Pay</label>
            <select id="gpay" required><option value="">Select…</option><option>Yes</option><option>No</option></select>
          </div>
        </div>
        <input type="hidden" id="editId">
        <div class="btns" style="margin-top:16px">
          <button type="submit" class="primary" id="saveBtn">Add Entry</button>
          <button type="reset" class="ghost">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- filters / export -->
  <div class="card">
    <div class="content">
      <h2>Filters & Export</h2>
      <div class="row">
        <div><label>From</label><input type="date" id="fromDate"></div>
        <div><label>To</label><input type="date" id="toDate"></div>
        <div><label>G-Pay</label>
          <select id="filterGpay"><option value="">All</option><option>Yes</option><option>No</option></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div style="grid-column:1/3">
          <label>Search Number</label><input type="text" id="search" placeholder="Type to search… (Alt+/)">
        </div>
        <div class="right" style="align-self:end"><button id="clearFilter" class="ghost">Clear</button></div>
      </div>
      <div class="btns" style="margin-top:14px">
        <button id="exportCSV">Export CSV</button>
        <button id="exportXLSX">Export Excel</button>
        <button id="exportJSON" class="ghost">Export JSON</button>
        <input type="file" id="importFile" accept=".json" hidden>
        <button id="importJSON" class="ghost">Import JSON</button>
        <button id="printPage" class="ghost">Print</button>
        <button id="clearAll" class="ghost danger">Delete All</button>
      </div>
    </div>
  </div>
</section>

<!-- ── ENTRIES ─────────────────────────────────────── -->
<section class="card" style="margin-top:18px">
  <div class="content">
    <h2>Entries</h2>
    <div class="tablewrap">
      <table id="entriesTable">
        <thead>
          <tr>
            <th data-key="idx">#</th><th data-key="date">Date</th><th data-key="number">Number</th>
            <th data-key="amount" class="nowrap">Amount (₹)</th><th data-key="gpay">G Pay</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"><tr><td colspan="6" class="empty">No entries yet.</td></tr></tbody>
        <tfoot><tr><td colspan="3">Total</td><td id="totalAmount">0.00</td><td colspan="2"></td></tr></tfoot>
      </table>
    </div>
  </div>
</section>

<!-- ── MONTHLY REPORT ──────────────────────────────── -->
<section class="card" style="margin-top:18px">
  <div class="content">
    <h2>📊 Monthly Report</h2>
    <div class="tablewrap">
      <table id="monthlyTable">
        <thead><tr><th>#</th><th>Month</th><th>Total Amount (₹)</th><th>Entries</th></tr></thead>
        <tbody id="monthlyBody"><tr><td colspan="4" class="empty">No data.</td></tr></tbody>
      </table>
    </div>
  </div>
</section>
</div>

<script>
/* ---------- HELPERS ---------- */
const $ = s=>document.querySelector(s);
const pad=n=>String(n).padStart(2,'0');
const todayStr=()=>{const d=new Date();return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
const fmt=n=>Number(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2});
const escapeHtml=s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const storeKey='daily-collections-v2';
const themeKey='dcr-theme';
function load(){try{return JSON.parse(localStorage.getItem(storeKey))||[]}catch{return[]}}
function save(list){localStorage.setItem(storeKey,JSON.stringify(list))}

/* ---------- STATE ---------- */
let entries=load();
let sortKey='date', sortDir=1;

/* ---------- THEME ---------- */
applyTheme(localStorage.getItem(themeKey)||'dark');
$('#themeBtn').onclick=()=>{
  const t=document.documentElement.classList.toggle('light')?'light':'dark';
  applyTheme(t);
};
function applyTheme(t){
  document.documentElement.classList.toggle('light',t==='light');
  $('#themeBtn').textContent=t==='light'?'🌙':'☀️';
  localStorage.setItem(themeKey,t);
}

/* ---------- INIT ---------- */
$('#date').value=todayStr();
render();

/* ---------- FORM SUBMIT WITH DUPLICATE CHECK ---------- */
$('#entryForm').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('#editId').value||crypto.randomUUID();
  const obj={
    id,
    date:$('#date').value,
    number:$('#number').value.trim(),
    amount:+($('#amount').value||0),
    gpay:$('#gpay').value
  };
  if(!obj.date||!obj.number||!obj.amount||!obj.gpay){
    alert('Fill all required fields.');return;
  }

  /* --- Prevent duplicate Number / Name ------------------ */
  const duplicate = entries.some(x =>
      x.id!==id && x.number.toLowerCase()===obj.number.toLowerCase()
  );
  if(duplicate){
    alert('This Number / Name already exists. Duplicates are not allowed.');
    $('#number').focus();return;
  }
  /* ------------------------------------------------------ */

  if($('#editId').value){             // update
    const i=entries.findIndex(x=>x.id===id);
    if(i>-1)entries[i]=obj;
  }else{                              // new
    entries.push(obj);
  }
  save(entries);
  $('#entryForm').reset();
  $('#date').value=todayStr();
  $('#saveBtn').textContent='Add Entry';
  $('#editId').value='';
  render();
});
$('#entryForm').addEventListener('reset',()=>{
  $('#saveBtn').textContent='Add Entry';
  $('#editId').value='';
  setTimeout(()=>$('#date').value=todayStr());
});

/* ---------- FILTERS ---------- */
['fromDate','toDate','filterGpay','search'].forEach(id=>$('#'+id).addEventListener('input',render));
$('#clearFilter').onclick=()=>{['fromDate','toDate','filterGpay','search'].forEach(id=>$('#'+id).value='');render();};

/* ---------- TABLE SORT HEADERS ---------- */
document.querySelectorAll('#entriesTable thead th[data-key]').forEach(th=>{
  th.onclick=()=>{
    const k=th.dataset.key;
    if(sortKey===k){sortDir*=-1;}else{sortKey=k;sortDir=1;}
    render();
  };
});
function markSorted(){
  document.querySelectorAll('#entriesTable thead th[data-key]').forEach(th=>{
    th.classList.toggle('sort-asc',th.dataset.key===sortKey&&sortDir===1);
    th.classList.toggle('sort-desc',th.dataset.key===sortKey&&sortDir===-1);
  });
}

/* ---------- RENDER ---------- */
function render(){
  const tbody=$('#tbody');tbody.innerHTML='';
  let view=entries.slice();

  /* filters */
  const fFrom=$('#fromDate').value, fTo=$('#toDate').value,
        fG=$('#filterGpay').value, q=$('#search').value.trim().toLowerCase();
  if(fFrom)view=view.filter(e=>e.date>=fFrom);
  if(fTo)view=view.filter(e=>e.date<=fTo);
  if(fG)view=view.filter(e=>e.gpay===fG);
  if(q)view=view.filter(e=>e.number.toLowerCase().includes(q));

  /* sort */
  view.sort((a,b)=>{
    const A=(a[sortKey]??'').toString(), B=(b[sortKey]??'').toString();
    return(A>B?1:-1)*sortDir;
  });

  let total=0;
  if(!view.length){
    tbody.innerHTML='<tr><td colspan="6" class="empty">No entries.</td></tr>';
  }else{
    view.forEach((e,i)=>{
      total+=e.amount;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${i+1}</td><td>${e.date}</td><td>${escapeHtml(e.number)}</td>
        <td class="nowrap">${fmt(e.amount)}</td>
        <td><span class="pill ${e.gpay==='Yes'?'yes':'no'}">${e.gpay}</span></td>
        <td>
          <button class="ghost" data-edit="${e.id}" title="Edit">✏️</button>
          <button class="ghost" data-del="${e.id}"  title="Delete">🗑️</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  $('#totalAmount').textContent=fmt(total);

  tbody.querySelectorAll('button[data-del]').forEach(b=>b.onclick=()=>{
    if(confirm('Delete this entry?')){
      entries=entries.filter(x=>x.id!==b.dataset.del);save(entries);render();
    }
  });
  tbody.querySelectorAll('button[data-edit]').forEach(b=>b.onclick=()=>startEdit(b.dataset.edit));
  markSorted();
  calcMonthly();
}
function startEdit(id){
  const e=entries.find(x=>x.id===id);if(!e)return;
  $('#date').value=e.date;$('#number').value=e.number;$('#amount').value=e.amount;$('#gpay').value=e.gpay;
  $('#editId').value=e.id;$('#saveBtn').textContent='Save';
  $('#amount').focus();
}

/* ---------- MONTHLY SUMMARY ---------- */
function calcMonthly(){
  const body=$('#monthlyBody');body.innerHTML='';
  if(!entries.length){body.innerHTML='<tr><td colspan="4" class="empty">No data.</td></tr>';return;}
  const map={};
  entries.forEach(e=>{
    const m=e.date.slice(0,7);
    if(!map[m])map[m]={total:0,count:0};map[m].total+=e.amount;map[m].count++;
  });
  const months=Object.keys(map).sort().reverse();
  let i=1;
  months.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i++}</td><td>${m}</td><td>${fmt(map[m].total)}</td><td>${map[m].count}</td>`;
    body.appendChild(tr);
  });
}

/* ---------- EXPORT / IMPORT / PRINT ---------- */
$('#exportCSV').onclick=()=>{
  if(!entries.length)return alert('No data');
  const rows=[['Date','Number','Amount','G Pay']];
  entries.forEach(e=>rows.push([e.date,e.number,e.amount,e.gpay]));
  const csv=rows.map(r=>r.map(v=>(""+v).includes(',')?'"'+(""+v).replace(/"/g,'""')+'"':v).join(',')).join('\n');
  download(new Blob([csv],{type:'text/csv'}),'collection.csv');
};
$('#exportXLSX').onclick=()=>{
  if(!entries.length)return alert('No data');
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(entries.map(e=>({Date:e.date,Number:e.number,Amount:e.amount,'G Pay':e.gpay})));
  XLSX.utils.book_append_sheet(wb,ws,'Entries');
  XLSX.writeFile(wb,'collection.xlsx');
};
$('#exportJSON').onclick=()=>download(new Blob([JSON.stringify(entries,null,2)],{type:'application/json'}),'collection-backup.json');
$('#importJSON').onclick=()=>$('#importFile').click();
$('#importFile').addEventListener('change',ev=>{
  const file=ev.target.files[0];if(!file)return;
  const rd=new FileReader();
  rd.onload=e=>{
    try{
      const arr=JSON.parse(e.target.result);
      if(!Array.isArray(arr))throw'bad';
      const before=entries.length;
      arr.forEach(o=>{if(!entries.some(x=>x.id===o.id))entries.push(o)});
      save(entries);render();
      alert(`Imported ${entries.length-before} new entries.`);
    }catch{alert('Invalid file.')}
    ev.target.value='';
  };
  rd.readAsText(file);
});
$('#printPage').onclick=()=>window.print();
$('#clearAll').onclick=()=>{if(confirm('Delete ALL entries?')){entries=[];save(entries);render();}};

function download(blob,name){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=name;a.click();}

/* ---------- SHORTCUTS & UX ---------- */
document.addEventListener('keydown',e=>{
  if(e.altKey&&e.key==='n'){$('#amount').focus()}
  if(e.altKey&&e.key==='s'){$('#entryForm').requestSubmit()}
  if(e.altKey&&e.key==='/'){$('#search').focus();e.preventDefault()}
});
document.querySelectorAll('input[type="text"],input[type="number"]').forEach(inp=>inp.addEventListener('focus',()=>inp.select()));
</script>
</body>
</html>
